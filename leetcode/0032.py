#!/usr/bin/python3
"""
32. Longest Valid Parentheses
Difficulty: Hard

"""
class Solution:
    def longestValidParentheses(self, s: str) -> int:
        if len(s) < 2: return 0

        dp_dict = {}
        for i in range(1, len(s)):
            if (s[i - 1] == '(') and (s[i] == ')'): dp_dict[i - 1] = 2

        exhausted_counter = 0
        size = 2
        result = 0
        while size < len(s):
            for idx in list(dp_dict):
                if dp_dict[idx] == size:
                    if (idx >= 1) and (idx + size <= len(s) - 1):
                        if (s[idx - 1] == '(') and (s[idx + size] == ')'):
                            dp_dict[idx - 1] = dp_dict[idx] + 2
                            continue
                    if idx >= 2:
                        if s[idx - 2:idx] == '()':
                            dp_dict[idx - 2] = dp_dict[idx] + 2
                            continue
                    if idx + size <= len(s) - 2:
                        if s[idx + size:idx + size + 2] == '()':
                            dp_dict[idx] = dp_dict[idx] + 2
                            continue

            dp_dict_list = list(sorted(dp_dict.keys()))
            for i in range(len(dp_dict_list)):
                idx1 = dp_dict_list[i]
                for j in range(i + 2, i + 243):
                    if j < len(dp_dict) - 1:
                        idx2 = dp_dict_list[j]
                        if idx1 + dp_dict[idx1] == idx2:
                            dp_dict[idx1] = dp_dict[idx1] + dp_dict[idx2]
                            break
                    else:
                        break

            if len(dp_dict) > 0:
                if max(dp_dict.values()) > result:
                    exhausted_counter = 0
                    result = max(dp_dict.values())
                if max(dp_dict.values()) == result: exhausted_counter += 1
                if exhausted_counter > 123: break

            size += 2

        if len(dp_dict) == 0: return 0
        return max(dp_dict.values())


sol = Solution()
print(sol.longestValidParentheses(
    s="))())(()))()(((()())(()(((()))))((()(())()((((()))())))())))()(()(()))))())(((())(()()))((())()())((()))(()(())(())((())((((()())()))((()(())()))()(()))))))()))(()))))()())()())()()()()()()()))()(((()()((()(())((()())))(()())))))))(()()(())())(()))))))()()())((((()()()())))))((())(())()()(()((()()))()()())(()())()))()(()(()())))))())()(())(()))(())()(())()((())()((((()()))())(((((())))())())(()((())((()()((((((())))(((())))))))(()()((((((()(((())()(()))(()())((()(((()((()(())())()())(((()))()(((()))))(())))(())()())()(((()))))((())())))())()()))((((()))(())()())()(((())(())(()()((())()())()()())())))((()())(()((()()()(()())(()))(()())((((()(()(((()(((())()((()(()))())()())))))))))))()())()(()(((())()))(((()))((((()())())(()())((()())(()()((()((((()())))()(())(())()))))(())())))))(((((((())(((((()))()))(()()()()))))))(()(()(()(()()(((()()))((()))())((())())()())()))()()(((())))()(())()()(())))(((()))))))))(())((()((()((()))))()()()((())((((((((((()(())))(())((()(()())())(((((((()()()()))())(((()())()(()()))))(()()))))(((()()((()()()(((()))))(()()())()()()(()))))()(())))))))()((((((((()((())))))))(()))()((()())())("))

# if sol.longestValidParentheses(s="((()))())") != 8: print('err-208')
# if sol.longestValidParentheses(s="(()") != 2: print('err-1')
# if sol.longestValidParentheses(s=")()())") != 4: print('err-2')
# if sol.longestValidParentheses(s="") != 0: print('err-3')
# if sol.longestValidParentheses(s="()(()") != 2: print('err-4')
# if sol.longestValidParentheses(s=")(((((()())()()))()(()))(") != 22: print('err-5')
# if sol.longestValidParentheses(s="))))))))") != 0: print('err-49')
# if sol.longestValidParentheses(
#         s="((())())(()))(()()(()(()))(()((((()))))))((()())()))()()(()(((((()()()())))()())(()()))((((((())))((()))()()))))(()))())))()))()())((()()))))(()(((((())))))()((()(()(())((((())(())((()()(()())))())(()(())()()))())(()()()))()(((()())(((()()())))(((()()()))(()()))()))()))))))())()()((()(())(()))()((()()()((())))()(((()())(()))())())))(((()))))())))()(())))()())))())()((()))((()))()))(((())((()()()(()((()((())))((()()))())(()()(()))))())((())))(()))()))))))()(()))())(()())))))(()))((())(()((())(((((()()()(()()())))(()())()((()(()()))(()(())((()((()))))))))(()(())()())()(()(()(()))()()()(()()())))(())(()((((()()))())))(())((()(())())))))())()()))(((())))())((()(()))(()()))((())(())))))(()(()((()((()()))))))(()()()(()()()(()(())()))()))(((()(())()())(()))())))(((()))())(()((()))(()((()()()(())()(()())()(())(()(()((((())()))(((()()(((()())(()()()(())()())())(()(()()((()))))()(()))))(((())))()()))(()))((()))))()()))))((((()(())()()()((()))((()))())())(()((()()())))))))()))(((()))))))(()())))(((()))((()))())))(((()(((())))())(()))))(((()(((((((((((((())(((()))((((())())()))())((((())(((())))())(((()))))()())()(())())(()))))()))()()()))(((((())()()((()))())(()))()()(()()))(())(()()))()))))(((())))))((()()(()()()()((())((((())())))))((((((()((()((())())(()((()))(()())())())(()(())(())(()((())((())))(())())))(()()())((((()))))((()(())(()(()())))))))))((()())()()))((()(((()((()))(((((()()()()()(()(()((()(()))(()(()((()()))))()(()()((((((()((()())()))((())()()(((((()(()))))()()((()())((()())()(())((()))()()(()))") != 168: print(
#     'err-6')
# if sol.longestValidParentheses(
#         s="))))())()(())((()()()((((()))))()()))((()(((((()((()(()()))(((())))()))()))()))()))(()()(()(()()()()()()()))())(()(((()(((())(())())))))(()()((()(())())((((())()()))(()))((((())))()())(()))))()())") != 188: print(
#     'err-218')
# if sol.longestValidParentheses(
#         s="())()()(())((()(()()(((()))((((())((()(())()())(()((((()))()(()))(())()(())(()(((((())((((((()())())(()(()((())()))(()))))))()(()))((((())()()()))()()()(((()(()())(()()(()(()()(((()))))))()()))())())((()()))))))((()))(((()((())()(()()))((())))()()())))))))()))))(()))))()))()))()((())))((()))(()))))))(((()))))))))()(()()()(())((())()))()()(())))()()))(()())()))(((()())()))((())((((()))(()(()(()()()(((())()(((((()))((()(((((())(()()))((((((((()(()(()(()(())))(())(()())())(()((((()(())((()(())))(())))()(((((()(()()(())))))))())(())(())(()()(((())))((()))(((((()))))())))()((()))()))))())))))((())(((((()()))((((())))(((()(()(())())(((()(()(()()()())))())()))((()((())())()()()(((())(((((()((((((()((()())))((((())((()(((((((()(()((()()()(()(()())(()(()()((((())))()(((()())))(()()))()(()()()()(((((())(()))))((()))())))()((((((()))())))()(()))(())))((((()())(((((()()())(((((())(()())(()))))()(()()))()))))))())))(((())(()(()()))(()))()(((())))())((((()(((()))))))()(()(()))()()(()()))))))))((()))))))(())((()((()))()))((((((()())))))(()((())((((()))))(()(()()()()(()))()()(()(()))(()()(((((((()())(())(()())((())())()(()())((())()())())(()())))())))(())())())(())((()())(((()()))()))()()))()(()(())((((((((())))()((())((()((((((((((()))))(()(((((())(()(()())())))((())())))))()))(()((()()))((()((())()()()((()(())())((())())(()()(((())))))())()()(()))()())(()(()((())))((((()()(())))())(())(()(()(())())())(()()())()(())())))(()()(((())))((()()(((())()()(()())((((()()(()())(()((((()(()()(()(()(((()((()())(()()))(()((((()(((((()))))()()))(((()((((((()(()()()()())()))(()(())))))((()(((()())())))(((()()))(()(()(((((((()()))(()(())))())()(())())(())(()))(())(()))()()(()()())))))()))()((())(((()((((((((())()()))())))((()())(") != 310: print(
#     'err-219')
#
# if sol.longestValidParentheses(
#         s="))())(()))()(((()())(()(((()))))((()(())()((((()))())))())))()(()(()))))())(((())(()()))((())()())((()))(()(())(())((())((((()())()))((()(())()))()(()))))))()))(()))))()())()())()()()()()()()))()(((()()((()(())((()())))(()())))))))(()()(())())(()))))))()()())((((()()()())))))((())(())()()(()((()()))()()())(()())()))()(()(()())))))())()(())(()))(())()(())()((())()((((()()))())(((((())))())())(()((())((()()((((((())))(((())))))))(()()((((((()(((())()(()))(()())((()(((()((()(())())()())(((()))()(((()))))(())))(())()())()(((()))))((())())))())()()))((((()))(())()())()(((())(())(()()((())()())()()())())))((()())(()((()()()(()())(()))(()())((((()(()(((()(((())()((()(()))())()())))))))))))()())()(()(((())()))(((()))((((()())())(()())((()())(()()((()((((()())))()(())(())()))))(())())))))(((((((())(((((()))()))(()()()()))))))(()(()(()(()()(((()()))((()))())((())())()())()))()()(((())))()(())()()(())))(((()))))))))(())((()((()((()))))()()()((())((((((((((()(())))(())((()(()())())(((((((()()()()))())(((()())()(()()))))(()()))))(((()()((()()()(((()))))(()()())()()()(()))))()(())))))))()((((((((()((())))))))(()))()((()())())(") != 490: print(
#     'err-220')
#
# if sol.longestValidParentheses(
#         s="((()))((((((()))))((())(()())(()((()()(()()))((())((((()))(()())))))())))()())((()()))((((()()()()()((()())))(())((()(()((()))()()()))()(())()))))))()(()))((()()()()())(()()()))(())((())())") != 146: print(
#     'err-215')
